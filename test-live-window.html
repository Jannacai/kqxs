<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Live Window Manager</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .active { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .inactive { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .debug { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h1>Test Live Window Manager</h1>
    
    <div id="status" class="status inactive">
        <strong>Tr·∫°ng th√°i Live Window:</strong> <span id="liveStatus">Kh√¥ng ho·∫°t ƒë·ªông</span>
    </div>
    
    <div id="debug" class="status debug">
        <strong>Debug Info:</strong>
        <div id="debugInfo">ƒêang kh·ªüi t·∫°o...</div>
    </div>
    
    <div>
        <h3>H∆∞·ªõng d·∫´n test:</h3>
        <ul>
            <li>M·ªü Console (F12) ƒë·ªÉ xem debug logs</li>
            <li>Live Window s·∫Ω ho·∫°t ƒë·ªông t·ª´ 17:10-17:59</li>
            <li>H√†m c√†o s·∫Ω k√≠ch ho·∫°t l√∫c 17:14</li>
            <li>Ki·ªÉm tra logs ƒë·ªÉ xem ho·∫°t ƒë·ªông</li>
        </ul>
    </div>

    <script>
        // Mock LiveWindowManager cho test
        class LiveWindowManager {
            constructor() {
                this.isLiveWindowActive = false;
                this.scraperTriggered = false;
                this.lastScraperDate = null;
                this.listeners = new Set();
                this.scraperListeners = new Set();
                this.checkInterval = null;
                this.station = 'xsmt';
            }

            start() {
                console.log('üöÄ Kh·ªüi ƒë·ªông LiveWindowManager');
                this.checkTime();
                this.checkInterval = setInterval(() => this.checkTime(), 5000);
            }

            checkTime() {
                const now = new Date();
                const vietnamTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Ho_Chi_Minh' }));
                const vietnamHours = vietnamTime.getHours();
                const vietnamMinutes = vietnamTime.getMinutes();
                const today = vietnamTime.toLocaleDateString('vi-VN').replace(/\//g, '-');

                // Debug log ƒë·ªÉ ki·ªÉm tra th·ªùi gian
                console.log(`üïê Debug LiveWindowManager: ${vietnamHours}:${vietnamMinutes.toString().padStart(2, '0')} - ${today}`);

                // Reset m·ªói ng√†y
                if (this.lastScraperDate !== today) {
                    this.scraperTriggered = false;
                    this.lastScraperDate = null;
                    console.log('üîÑ Reset scraper trigger cho ng√†y m·ªõi:', today);
                }

                // Ki·ªÉm tra live window (17:10-17:59)
                const isLiveWindow = vietnamHours === 17 && vietnamMinutes >= 10 && vietnamMinutes <= 59;

                // Debug log ƒë·ªÉ ki·ªÉm tra ƒëi·ªÅu ki·ªán live window
                console.log(`üîç Live window check: ${vietnamHours} === 17 && ${vietnamMinutes} >= 10 && ${vietnamMinutes} <= 59 = ${isLiveWindow}`);

                if (isLiveWindow !== this.isLiveWindowActive) {
                    this.isLiveWindowActive = isLiveWindow;
                    console.log(`üîÑ Live window ${isLiveWindow ? 'activated' : 'deactivated'} (${vietnamHours}:${vietnamMinutes.toString().padStart(2, '0')})`);
                    console.log(`üì° Notifying ${this.listeners.size} listeners`);
                    this.notifyListeners(isLiveWindow);
                }

                // K√≠ch ho·∫°t h√†m c√†o ch·ªâ 1 l·∫ßn ·ªü 17:14
                if (vietnamHours === 17 && vietnamMinutes === 14 && !this.scraperTriggered) {
                    console.log(`üöÄ Triggering scraper at ${vietnamHours}:${vietnamMinutes.toString().padStart(2, '0')}`);
                    this.triggerScraper(today);
                }

                // C·∫≠p nh·∫≠t UI
                this.updateUI(vietnamHours, vietnamMinutes, isLiveWindow);
            }

            updateUI(hours, minutes, isLiveWindow) {
                const statusEl = document.getElementById('status');
                const liveStatusEl = document.getElementById('liveStatus');
                const debugEl = document.getElementById('debugInfo');

                if (isLiveWindow) {
                    statusEl.className = 'status active';
                    liveStatusEl.textContent = 'ƒêang ho·∫°t ƒë·ªông';
                } else {
                    statusEl.className = 'status inactive';
                    liveStatusEl.textContent = 'Kh√¥ng ho·∫°t ƒë·ªông';
                }

                debugEl.innerHTML = `
                    <div>Th·ªùi gian hi·ªán t·∫°i: ${hours}:${minutes.toString().padStart(2, '0')}</div>
                    <div>Live Window: ${isLiveWindow ? 'C√≥' : 'Kh√¥ng'}</div>
                    <div>Scraper Triggered: ${this.scraperTriggered ? 'C√≥' : 'Kh√¥ng'}</div>
                    <div>Listeners: ${this.listeners.size}</div>
                `;
            }

            async triggerScraper(today) {
                if (this.scraperTriggered) {
                    console.log('üîÑ Scraper ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t, b·ªè qua');
                    return;
                }

                console.log('üöÄ K√≠ch ho·∫°t h√†m c√†o l·∫ßn ƒë·∫ßu ti√™n');
                this.scraperTriggered = true;
                this.lastScraperDate = today;

                // Mock API call
                console.log('üì° G·ªçi API h√†m c√†o v·ªõi date:', today, 'station:', this.station);
                
                // Th√¥ng b√°o cho t·∫•t c·∫£ listeners
                this.notifyScraperListeners(today);
            }

            addListener(callback) {
                this.listeners.add(callback);
                return () => this.listeners.delete(callback);
            }

            addScraperListener(callback) {
                this.scraperListeners.add(callback);
                return () => this.scraperListeners.delete(callback);
            }

            notifyListeners(isLiveWindow) {
                this.listeners.forEach(callback => callback(isLiveWindow));
            }

            notifyScraperListeners(today) {
                this.scraperListeners.forEach(callback => callback(today));
            }

            stop() {
                if (this.checkInterval) {
                    clearInterval(this.checkInterval);
                    this.checkInterval = null;
                }
                console.log('üõë D·ª´ng LiveWindowManager');
            }
        }

        // Kh·ªüi t·∫°o v√† test
        const liveWindowManager = new LiveWindowManager();
        
        // Subscribe ƒë·ªÉ test
        liveWindowManager.addListener((isActive) => {
            console.log(`üîÑ Test listener nh·∫≠n th√¥ng b√°o: ${isActive}`);
        });

        liveWindowManager.addScraperListener((today) => {
            console.log(`üì° Test scraper listener nh·∫≠n th√¥ng b√°o: ${today}`);
        });

        // Kh·ªüi ƒë·ªông
        liveWindowManager.start();

        // Cleanup khi ƒë√≥ng trang
        window.addEventListener('beforeunload', () => {
            liveWindowManager.stop();
        });
    </script>
</body>
</html> 